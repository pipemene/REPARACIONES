<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Bluehome</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div class="flex min-h-screen">
  <aside class="w-64 bg-blue-800 text-white p-6">
    <img src="logo-white.png" class="mb-6 w-32 mx-auto">
    <ul>
      <li><a href="#" onclick="mostrar('crear')" class="block py-2">Crear Orden</a></li>
      <li><a href="#" onclick="mostrar('listar')" class="block py-2">Órdenes de Trabajo</a></li>
      <li><a href="#" onclick="logout()" class="block py-2">Cerrar sesión</a></li>
    </ul>
  </aside>
  <main class="flex-1 p-6">
    <section id="crear" class="hidden">
      <h2 class="text-xl font-bold mb-4">Crear Orden</h2>
      <input id="codigo" type="text" placeholder="Código inmueble" class="border p-2 mb-2 block w-1/2">
      <input id="cliente" type="text" placeholder="Cliente" class="border p-2 mb-2 block w-1/2">
      <input id="telefono" type="text" placeholder="Teléfono" class="border p-2 mb-2 block w-1/2">
      <textarea id="descripcion" placeholder="Descripción" class="border p-2 mb-2 block w-1/2"></textarea>
      <button onclick="crearOrden()" class="bg-blue-600 text-white px-4 py-2 rounded">Guardar</button>
    </section>

    <section id="listar" class="hidden">
      <h2 class="text-xl font-bold mb-4">Órdenes de Trabajo</h2>
      <div class="flex space-x-4 mb-4">
        <select id="filtroTecnico" class="border p-2">
          <option value="">Todos los técnicos</option>
          <option value="DAYAN">Dayan</option>
          <option value="MAURICIO">Mauricio</option>
          <option value="JAIR">Jair</option>
          <option value="JUANDAVID">Juandavid</option>
        </select>
        <select id="filtroEstado" class="border p-2">
          <option value="">Todos los estados</option>
          <option value="Pendiente">Pendiente</option>
          <option value="En proceso">En proceso</option>
          <option value="Finalizado">Finalizado</option>
        </select>
        <input type="date" id="filtroDesde" class="border p-2">
        <input type="date" id="filtroHasta" class="border p-2">
        <button onclick="cargarOrdenes()" class="bg-gray-700 text-white px-3 py-1 rounded">Filtrar</button>
      </div>
      <table class="table-auto w-full border" id="tabla">
        <thead><tr><th>Radicado</th><th>Fecha</th><th>Cliente</th><th>Descripción</th><th>Técnico</th><th>Estado</th><th>PDF</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="mt-4 flex justify-between">
        <button onclick="prevPage()" class="px-3 py-1 bg-blue-500 text-white rounded">Anterior</button>
        <span id="pagina"></span>
        <button onclick="nextPage()" class="px-3 py-1 bg-blue-500 text-white rounded">Siguiente</button>
      </div>
    </section>
  </main>
</div>
<script>
  let ordenes = [];
  let paginaActual = 1;
  const porPagina = 15;

  function mostrar(id) {
    document.getElementById('crear').classList.add('hidden');
    document.getElementById('listar').classList.add('hidden');
    document.getElementById(id).classList.remove('hidden');
    if(id==='listar') cargarOrdenes();
  }

  function logout() {
    localStorage.clear();
    window.location.href = '/';
  }

  async function crearOrden() {
    alert("🚧 Aquí se implementa POST a Google Sheets");
  }

  async function cargarOrdenes() {
    const token = localStorage.getItem('token');
    const resp = await fetch('/api/ordenes', { headers: { 'Authorization': 'Bearer ' + token } });
    const data = await resp.json();
    if(data.ok) {
      ordenes = data.data;
      aplicarFiltros();
    }
  }

  function aplicarFiltros() {
    const tecnico = document.getElementById('filtroTecnico').value;
    const estado = document.getElementById('filtroEstado').value;
    const desde = document.getElementById('filtroDesde').value;
    const hasta = document.getElementById('filtroHasta').value;
    let filtradas = ordenes;
    if(tecnico) filtradas = filtradas.filter(o => o.tecnico===tecnico);
    if(estado) filtradas = filtradas.filter(o => o.estado===estado);
    if(desde) filtradas = filtradas.filter(o => o.fecha>=desde);
    if(hasta) filtradas = filtradas.filter(o => o.fecha<=hasta);
    mostrarPagina(filtradas, paginaActual);
  }

  function mostrarPagina(lista, pagina) {
    const tbody = document.querySelector('#tabla tbody');
    tbody.innerHTML = "";
    const inicio = (pagina-1)*porPagina;
    const fin = inicio+porPagina;
    const paginaDatos = lista.slice(inicio, fin);
    paginaDatos.forEach(o => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${o.radicado}</td><td>${o.fecha}</td><td>${o.inquilino}</td><td>${o.descripcion}</td><td>${o.tecnico}</td><td>${o.estado}</td><td><a href="/api/ordenes/${o.radicado}/pdf" target="_blank" class="text-blue-600">PDF</a></td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('pagina').textContent = `Página ${pagina}`;
  }

  function prevPage() { if(paginaActual>1){ paginaActual--; aplicarFiltros(); } }
  function nextPage() { paginaActual++; aplicarFiltros(); }
</script>
</body>
</html>
