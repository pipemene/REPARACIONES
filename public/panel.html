
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reparaciones · Panel</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="topbar">
    <img src="/logo.png" alt="Blue Home" />
    <div class="sp"></div>
    <div id="who" style="color:#fff;"></div>
    <button class="btn" onclick="logout()">Cerrar sesión</button>
  </div>
  <div class="container">
    <div id="err" class="notice" style="display:none"></div>
    <div class="navbar" id="prettyTabs"></div>

    <div id="err" class="notice" style="display:none"></div>
    <nav class="tabs" id="tabs"></nav>

    <!-- Secciones -->
    <section id="tab-usuarios" class="card hidden">
      <h3>Usuarios (superadmin)</h3>
      <div class="row">
        <input id="uUsuario" placeholder="Usuario" />
        <input id="uPass" placeholder="Contraseña" />
        <select id="uRol"></select>
        <button onclick="createUser()">Crear usuario</button>
      </div>
      <div class="row">
        <input id="uIdEdit" placeholder="ID a editar" />
        <input id="uPassEdit" placeholder="Nueva contraseña (opcional)" />
        <select id="uRolEdit"><option value="">(rol sin cambios)</option></select>
        <button onclick="editUser()">Guardar cambios</button>
        <input id="uIdDel" placeholder="ID a eliminar" />
        <button onclick="delUser()">Eliminar</button>
      </div>
      <div class="row">
        <button onclick="listUsers()">Actualizar listado</button>
      </div>
      <div id="usersOut"></div>
    </section>

    <section id="tab-ordenes" class="card hidden">
      <h3>Órdenes</h3>
      <div class="row" id="ordenesAdminControls" class="hidden">
        <input id="oCodigo" placeholder="Código inmueble" />
        <input id="oNombre" placeholder="Cliente" />
        <input id="oTel" placeholder="Teléfono" />
        <input id="oDesc" placeholder="Descripción" style="flex:2" />
        <button onclick="crearOrden()">Crear</button>
        <button onclick="listOrdenes()">Listar</button>
      </div>
      <div class="row" id="asignControls" class="hidden">
        <input id="asigId" placeholder="ID orden" />
        <input id="asigTec" placeholder="ID técnico" />
        <button onclick="asignar()">Asignar técnico</button>
        <input id="pdfId" placeholder="ID orden" />
        <button onclick="descargarPDF()">Descargar PDF</button>
      </div>
      <div class="row" id="tecControls" class="hidden">
        <button onclick="listarMisOrdenes()">Listar mis órdenes</button>
        <input id="tomarId" placeholder="ID orden" />
        <button onclick="tomar()">Tomar orden</button>
        <input id="estadoId" placeholder="ID orden" />
        <select id="estadoNew">
          <option value="pendiente">pendiente</option>
          <option value="en_proceso">en_proceso</option>
          <option value="finalizada">finalizada</option>
        </select>
        <button onclick="cambiarEstado()">Cambiar estado</button>
        <input id="eviId" placeholder="ID orden" />
        <input id="eviFile" type="file" />
        <button onclick="subirEvidencia()">Subir evidencia</button>
      </div>
      <h4 id="firmaTitulo" class="hidden">Firma del inquilino</h4>
      <canvas id="sig" width="320" height="160" class="hidden"></canvas>
      <div class="row hidden" id="firmaControls">
        <input id="sigId" placeholder="ID orden" />
        <button onclick="limpiarFirma()">Limpiar</button>
        <button onclick="enviarFirma()">Guardar firma</button>
      </div>
      <pre id="ordenesOut"></pre>
    </section>
  </div>

<script>
// --- Robust session retrieval ---
function getSession(){
  const params = new URLSearchParams(location.search);
  let rol = params.get('rol'); 
  let idStr = params.get('id'); 
  let usuario = params.get('usuario');
  let id = idStr ? parseInt(idStr) : NaN;
  if(!rol || !usuario || Number.isNaN(id)){
    try{
      const s = JSON.parse(sessionStorage.getItem('session')||'null');
      if(s){ rol = s.rol; id = s.id; usuario = s.usuario; }
    }catch(e){}
  }
  if(!rol || !usuario || !Number.isFinite(id)){
    return null;
  }
  return {rol, id, usuario};
}

const sess = getSession();
const who = document.getElementById('who');
const tabs = document.getElementById('prettyTabs');
function prettyBtn(id,label,active=false){
  const b=document.createElement('div');
  b.className='nav-item'+(active?' active':'');
  b.onclick=()=>activateTab(id);
  const dot=document.createElement('span'); dot.className='nav-icon';
  const text=document.createElement('span'); text.textContent=label;
  b.appendChild(dot); b.appendChild(text);
  return b;
}
setup().catch(err=>{ errBox.style.display='block'; errBox.textContent='Error en panel: '+err.message; });
</script>
</body>
</html>
