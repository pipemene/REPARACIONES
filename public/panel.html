
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reparaciones · Panel</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="topbar">
    <img src="/logo.png" alt="Blue Home" />
    <div class="sp"></div>
    <div id="who"></div>
    <button class="btn" onclick="logout()">Cerrar sesión</button>
  </div>
  <div class="container">
    <div id="err" class="notice" style="display:none"></div>
    <nav class="tabs" id="tabs"></nav>

    <!-- Secciones -->
    <section id="tab-usuarios" class="card hidden">
      <h3>Usuarios (superadmin)</h3>
      <div class="row">
        <input id="uUsuario" placeholder="Usuario" />
        <input id="uPass" placeholder="Contraseña" />
        <select id="uRol"></select>
        <button onclick="createUser()">Crear usuario</button>
      </div>
      <div class="row">
        <input id="uIdEdit" placeholder="ID a editar" />
        <input id="uPassEdit" placeholder="Nueva contraseña (opcional)" />
        <select id="uRolEdit"><option value="">(rol sin cambios)</option></select>
        <button onclick="editUser()">Guardar cambios</button>
        <input id="uIdDel" placeholder="ID a eliminar" />
        <button onclick="delUser()">Eliminar</button>
      </div>
      <div class="row">
        <button onclick="listUsers()">Actualizar listado</button>
      </div>
      <div id="usersOut"></div>
    </section>

    <section id="tab-ordenes" class="card hidden">
      <h3>Órdenes</h3>
      <div class="row" id="ordenesAdminControls" class="hidden">
        <input id="oCodigo" placeholder="Código inmueble" />
        <input id="oNombre" placeholder="Cliente" />
        <input id="oTel" placeholder="Teléfono" />
        <input id="oDesc" placeholder="Descripción" style="flex:2" />
        <button onclick="crearOrden()">Crear</button>
        <button onclick="listOrdenes()">Listar</button>
      </div>
      <div class="row" id="asignControls" class="hidden">
        <input id="asigId" placeholder="ID orden" />
        <input id="asigTec" placeholder="ID técnico" />
        <button onclick="asignar()">Asignar técnico</button>
        <input id="pdfId" placeholder="ID orden" />
        <button onclick="descargarPDF()">Descargar PDF</button>
      </div>
      <div class="row" id="tecControls" class="hidden">
        <button onclick="listarMisOrdenes()">Listar mis órdenes</button>
        <input id="tomarId" placeholder="ID orden" />
        <button onclick="tomar()">Tomar orden</button>
        <input id="estadoId" placeholder="ID orden" />
        <select id="estadoNew">
          <option value="pendiente">pendiente</option>
          <option value="en_proceso">en_proceso</option>
          <option value="finalizada">finalizada</option>
        </select>
        <button onclick="cambiarEstado()">Cambiar estado</button>
        <input id="eviId" placeholder="ID orden" />
        <input id="eviFile" type="file" />
        <button onclick="subirEvidencia()">Subir evidencia</button>
      </div>
      <h4 id="firmaTitulo" class="hidden">Firma del inquilino</h4>
      <canvas id="sig" width="320" height="160" class="hidden"></canvas>
      <div class="row hidden" id="firmaControls">
        <input id="sigId" placeholder="ID orden" />
        <button onclick="limpiarFirma()">Limpiar</button>
        <button onclick="enviarFirma()">Guardar firma</button>
      </div>
      <pre id="ordenesOut"></pre>
    </section>
  </div>

<script>
const params = new URLSearchParams(location.search);
let rol = params.get('rol'); let id = parseInt(params.get('id')); let usuario = params.get('usuario');
try{
  if(!rol || !id || !usuario){
    const s = JSON.parse(sessionStorage.getItem('session')||'null');
    if(s){ rol = s.rol; id = s.id; usuario = s.usuario; }
  }
}catch(e){}

const who = document.getElementById('who');
const tabs = document.getElementById('tabs');

function logout(){ location.href = '/'; }
function showEl(idEl, show=true){ document.getElementById(idEl).classList.toggle('hidden', !show); }

function setWho(){
  who.innerHTML = '<span class="badge">'+usuario+'</span> · <span class="badge">'+rol+'</span>';
}

function navButton(id, label, active=false){
  const b = document.createElement('button');
  b.textContent = label; b.onclick = ()=>activateTab(id);
  b.className = active ? 'active' : '';
  return b;
}

function activateTab(id){
  for(const el of ['tab-usuarios','tab-ordenes']) showEl(el, false);
  document.getElementById(id).classList.remove('hidden');
  for(const btn of tabs.querySelectorAll('button')) btn.classList.remove('active');
  const idx = id==='tab-usuarios' ? 0 : 1;
  tabs.querySelectorAll('button')[idx].classList.add('active');
}

// Setup UI by role
async function setup(){
  try{
  // Auto-redirect if params missing
  if(!rol){ location.href = '/'; return; }
  setWho();
  tabs.innerHTML = ''; tabs.style.display='flex';
  // Tabs config
  if(rol==='superadmin'){
    tabs.appendChild(navButton('tab-usuarios','Usuarios', true));
    tabs.appendChild(navButton('tab-ordenes','Órdenes'));
    // roles dropdowns
    const rroles = await fetch('/api/usuarios/roles'); const roles = await rroles.json();
    document.getElementById('uRol').innerHTML = roles.map(r=>`<option>${r}</option>`).join('');
    document.getElementById('uRolEdit').innerHTML += roles.map(r=>`<option>${r}</option>`).join('');
    showEl('tab-usuarios', true);
    await listUsers();
    showEl('ordenesAdminControls', true);
    showEl('asignControls', true);
  } else if(rol==='admin'){
    tabs.appendChild(navButton('tab-ordenes','Órdenes', true));
    showEl('tab-ordenes', true);
    showEl('ordenesAdminControls', true);
    showEl('asignControls', true);
  } else if(rol==='tecnico'){
    tabs.appendChild(navButton('tab-ordenes','Mis Órdenes', true));
    showEl('tab-ordenes', true);
    showEl('tecControls', true);
    showEl('firmaTitulo', true);
    showEl('sig', true);
    showEl('firmaControls', true);
  }
}

  } catch(err){ const e=document.getElementById('err'); e.style.display='block'; e.textContent='Error inicializando: '+err.message; }

// Usuarios
async function listUsers(){
  const out = document.getElementById('usersOut');
  out.innerHTML = '<p class="badge">Cargando usuarios...</p>';
  try{
    const r = await fetch('/api/usuarios', { cache: 'no-store' });
    if(!r.ok){ throw new Error('HTTP '+r.status); }
    const j = await r.json();
    if(!Array.isArray(j) || j.length===0){
      out.innerHTML = '<div class="notice">⚠️ No hay usuarios registrados.</div>';
      return;
    }
    const rows = j.map(u => `<tr><td>${u.id}</td><td>${u.usuario}</td><td>${u.rol}</td></tr>`).join('');
    out.innerHTML = `<table><thead><tr><th>ID</th><th>Usuario</th><th>Rol</th></tr></thead><tbody>${rows}</tbody></table>`;
  } catch(err){
    out.innerHTML = `<div class="notice">❌ Error cargando usuarios: ${err.message}</div>`;
  }
}
  const rows = j.map(u => `<tr><td>${u.id}</td><td>${u.usuario}</td><td>${u.rol}</td></tr>`).join('');
  out.innerHTML = `<table><thead><tr><th>ID</th><th>Usuario</th><th>Rol</th></tr></thead><tbody>${rows}</tbody></table>`;
}
async function createUser(){
  const usuario = document.getElementById('uUsuario').value;
  const password = document.getElementById('uPass').value;
  const rol = document.getElementById('uRol').value;
  const r = await fetch('/api/usuarios',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({usuario,password,rol})});
  const j = await r.json(); document.getElementById('usersOut').textContent = JSON.stringify(j,null,2);
}
async function editUser(){
  const idEdit = document.getElementById('uIdEdit').value;
  const password = document.getElementById('uPassEdit').value;
  const rol = document.getElementById('uRolEdit').value || undefined;
  const body = {}; if(password) body.password = password; if(rol) body.rol = rol;
  const r = await fetch('/api/usuarios/'+idEdit,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const j = await r.json(); document.getElementById('usersOut').textContent = JSON.stringify(j,null,2);
}
async function delUser(){
  const idDel = document.getElementById('uIdDel').value;
  const r = await fetch('/api/usuarios/'+idDel,{method:'DELETE'});
  const j = await r.json(); document.getElementById('usersOut').textContent = JSON.stringify(j,null,2);
}

// Órdenes
async function listOrdenes(){ const r=await fetch('/api/ordenes'); const j=await r.json(); document.getElementById('ordenesOut').textContent = JSON.stringify(j,null,2); }
async function crearOrden(){
  const codigoInmueble = document.getElementById('oCodigo').value;
  const nombre = document.getElementById('oNombre').value;
  const telefono = document.getElementById('oTel').value;
  const descripcion = document.getElementById('oDesc').value;
  const r = await fetch('/api/ordenes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({codigoInmueble,nombre,telefono,descripcion})});
  const j = await r.json(); document.getElementById('ordenesOut').textContent = JSON.stringify(j,null,2);
}
async function asignar(){
  const oid = document.getElementById('asigId').value;
  const tecnicoId = parseInt(document.getElementById('asigTec').value);
  const r = await fetch('/api/ordenes/'+oid+'/asignar',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({tecnicoId,usuario})});
  const j = await r.json(); document.getElementById('ordenesOut').textContent = JSON.stringify(j,null,2);
}
function descargarPDF(){ const oid=document.getElementById('pdfId').value; window.open('/api/ordenes/'+oid+'/pdf','_blank'); }

// Técnico
async function listarMisOrdenes(){
  const r = await fetch('/api/ordenes?mine=1&tecnicoId='+id);
  const j = await r.json();
  document.getElementById('ordenesOut').textContent = JSON.stringify(j,null,2);
}
async function tomar(){
  const oid = document.getElementById('tomarId').value;
  const r = await fetch('/api/ordenes/'+oid+'/tomar',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({tecnicoId:id, usuario})});
  const j = await r.json(); document.getElementById('ordenesOut').textContent = JSON.stringify(j,null,2);
}
async function cambiarEstado(){
  const oid = document.getElementById('estadoId').value;
  const estado = document.getElementById('estadoNew').value;
  const r = await fetch('/api/ordenes/'+oid,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({estado,usuario})});
  const j = await r.json(); document.getElementById('ordenesOut').textContent = JSON.stringify(j,null,2);
}
async function subirEvidencia(){
  const oid = document.getElementById('eviId').value;
  const f = document.getElementById('eviFile').files[0];
  if(!f){ alert('Selecciona archivo'); return; }
  const fd = new FormData(); fd.append('evidencia', f); fd.append('usuario', usuario);
  const r = await fetch('/api/ordenes/'+oid+'/evidencia',{ method:'POST', body: fd });
  const j = await r.json(); document.getElementById('ordenesOut').textContent = JSON.stringify(j,null,2);
}

// Firma
window.addEventListener('DOMContentLoaded', ()=>{
  const c = document.getElementById('sig'); if(!c) return;
  const ctx = c.getContext('2d');
  let drawing=false, prev=null;
  c.addEventListener('pointerdown', e=>{ drawing=true; prev={x:e.offsetX,y:e.offsetY}; });
  c.addEventListener('pointermove', e=>{
    if(!drawing) return;
    ctx.lineWidth = 2; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(prev.x, prev.y); ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke();
    prev={x:e.offsetX,y:e.offsetY};
  });
  c.addEventListener('pointerup', ()=>drawing=false);
  window.limpiarFirma = ()=>ctx.clearRect(0,0,c.width,c.height);
  window.enviarFirma = async ()=>{
    const oid = document.getElementById('sigId').value;
    const data = c.toDataURL('image/png');
    const r = await fetch('/api/ordenes/'+oid,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({firma:data,usuario})});
    const j = await r.json(); document.getElementById('ordenesOut').textContent = JSON.stringify(j,null,2);
  };
});

setup().catch(err=>{ const e=document.getElementById('err'); e.style.display='block'; e.textContent='Error en panel: '+err.message; });
</script>
</body>
</html>
