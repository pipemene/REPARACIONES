<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Órdenes de Servicio</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <h1>Órdenes de Servicio</h1>
  <table>
    <thead>
      <tr>
        <th>Radicado</th>
        <th>Fecha</th>
        <th>Inquilino</th>
        <th>Teléfono</th>
        <th>Código</th>
        <th>Descripción</th>
        <th>Técnico</th>
        <th>Estado</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody>
      <% ordenes.forEach(o => { %>
        <tr>
          <td><%= o.id %></td>
          <td><%= o.fecha %></td>
          <td><%= o.cliente %></td>
          <td><%= o.telefono %></td>
          <td><%= o.codigo %></td>
          <td><%= o.descripcion %></td>
          <td>
            <select id="tecnico-<%= o.id %>">
              <option value="">Sin asignar</option>
              <% tecnicos.forEach(t => { %>
                <option value="<%= t.id %>" <%= o.tecnicoId === t.id ? "selected" : "" %>>
                  <%= t.nombre %>
                </option>
              <% }) %>
            </select>
          </td>
          <td>
            <select id="estado-<%= o.id %>">
              <option value="Pendiente" <%= o.estado==="Pendiente"?"selected":"" %>>Pendiente</option>
              <option value="En proceso" <%= o.estado==="En proceso"?"selected":"" %>>En proceso</option>
              <option value="Finalizada" <%= o.estado==="Finalizada"?"selected":"" %>>Finalizada</option>
              <option value="Cancelada" <%= o.estado==="Cancelada"?"selected":"" %>>Cancelada</option>
            </select>
          </td>
          <td>
            <a href="/ordenes/<%= o.id %>">Ver</a>
            <button onclick="guardarCambios('<%= o.id %>')">Guardar cambios</button>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>

  <script>
    async function guardarCambios(ordenId) {
      const tecnicoId = document.getElementById(`tecnico-${ordenId}`).value;
      const estado = document.getElementById(`estado-${ordenId}`).value;
      try {
        const res = await fetch(`/ordenes/${ordenId}/update`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ tecnicoId, estado })
        });
        if (res.ok) alert("Orden actualizada ✅");
        else alert("Error ❌");
      } catch (err) {
        alert("Error de conexión ❌");
      }
    }
  </script>
</body>
</html>
