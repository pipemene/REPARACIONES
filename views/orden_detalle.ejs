<!DOCTYPE html>
<html>
<head>
  <title>Detalle Orden</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <h1>Detalle de Orden <%= orden.radicado %></h1>
  <p><b>Inquilino:</b> <%= orden.inquilino %></p>
  <p><b>Descripci√≥n:</b> <%= orden.descripcion %></p>

  <form id="finalizarForm">
    <label>Observaciones:</label><br>
    <textarea name="observaciones"></textarea><br><br>

    <label>Fotos:</label><br>
    <input type="file" id="fotos" multiple><br><br>

    <label>Firma:</label><br>
    <canvas id="firmaCanvas" width="300" height="150" style="border:1px solid black;"></canvas><br>
    <button type="button" onclick="limpiarFirma()">Limpiar</button><br><br>

    <button type="submit">Finalizar Orden</button>
  </form>

  <script>
    const form = document.getElementById('finalizarForm');
    const canvas = document.getElementById('firmaCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    canvas.addEventListener('mousedown', () => drawing = true);
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mousemove', dibujar);

    function dibujar(event) {
      if (!drawing) return;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';
      ctx.lineTo(event.offsetX, event.offsetY);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(event.offsetX, event.offsetY);
    }

    function limpiarFirma() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fotosInput = document.getElementById('fotos');
      const fotos = [];
      for (let file of fotosInput.files) {
        const base64 = await toBase64(file);
        fotos.push(base64);
      }

      const firma = canvas.toDataURL();

      const res = await fetch(`/ordenes/<%= orden.radicado %>/finalizar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          observaciones: form.observaciones.value,
          fotos,
          firma
        })
      });

      const data = await res.json();
      alert('Orden finalizada: ' + JSON.stringify(data));
      window.location.href = '/ordenes';
    });

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }
  </script>
</body>
</html>